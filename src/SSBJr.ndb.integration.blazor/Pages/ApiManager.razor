@page "/api-manager"
@using Microsoft.AspNetCore.SignalR.Client
@using System.Text.Json
@using System.Text
@implements IAsyncDisposable
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Gerenciador de APIs</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-4">
                ?? Gerenciador de APIs
            </h1>
            <p class="lead text-muted">Faça upload de arquivos Swagger JSON para hospedar APIs automaticamente</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">?? Nova API</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@newApiRequest" OnValidSubmit="@CreateApi">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome da API</label>
                            <InputText @bind-Value="newApiRequest.Name" class="form-control" placeholder="Ex: Minha API" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Descrição</label>
                            <InputTextArea @bind-Value="newApiRequest.Description" class="form-control" rows="3" placeholder="Descrição da API" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Arquivo Swagger JSON</label>
                            <InputFile OnChange="@OnFileSelected" class="form-control" accept=".json" />
                            @if (!string.IsNullOrEmpty(selectedFileName))
                            {
                                <small class="text-success mt-1 d-block">? @selectedFileName</small>
                            }
                        </div>
                        
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> @errorMessage
                            </div>
                        }
                        
                        <button type="submit" class="btn btn-primary w-100" disabled="@isUploading">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Criando...</text>
                            }
                            else
                            {
                                <i class="bi bi-plus-circle"></i>
                                <text>Criar API</text>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">?? APIs Hospedadas (@(apis?.Count ?? 0))</h5>
                    <button @onclick="LoadApis" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    @if (loadingApis)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-3 text-muted">Carregando APIs...</p>
                        </div>
                    }
                    else if (apis == null || !apis.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-1 mb-3"></i>
                            <h4>Nenhuma API hospedada ainda</h4>
                            <p>Faça o upload do seu primeiro arquivo Swagger para começar.</p>
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            @foreach (var api in apis)
                            {
                                <div class="col-12 mb-3">
                                    <div class="card border-start border-4 @GetApiCardBorderClass(api.Status)">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title fw-bold mb-1">@api.Name</h6>
                                                    @if (!string.IsNullOrEmpty(api.Description))
                                                    {
                                                        <p class="card-text text-muted small mb-0">@api.Description</p>
                                                    }
                                                </div>
                                                <span class="badge @GetStatusBadgeClass(api.Status) fs-6">
                                                    @GetStatusIcon(api.Status) @api.Status
                                                </span>
                                            </div>
                                            
                                            <div class="row g-2 mb-3">
                                                <div class="col-sm-6">
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar-event"></i>
                                                        Criado: @api.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                                    </small>
                                                </div>
                                                @if (api.LastHealthCheck.HasValue)
                                                {
                                                    <div class="col-sm-6">
                                                        <small class="text-muted">
                                                            <i class="bi bi-heart-pulse"></i>
                                                            Verificado: @api.LastHealthCheck.Value.ToString("dd/MM/yyyy HH:mm")
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                            
                                            @if (!string.IsNullOrEmpty(api.ErrorMessage))
                                            {
                                                <div class="alert alert-danger alert-sm mb-3">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    <small>@api.ErrorMessage</small>
                                                </div>
                                            }
                                            
                                            <div class="d-flex gap-1 flex-wrap">
                                                @if (api.Status == "Running")
                                                {
                                                    <button @onclick="() => StopApi(api.Id)" class="btn btn-warning btn-sm">
                                                        <i class="bi bi-pause-circle"></i> Parar
                                                    </button>
                                                }
                                                else if (api.Status == "Stopped")
                                                {
                                                    <button @onclick="() => StartApi(api.Id)" class="btn btn-success btn-sm">
                                                        <i class="bi bi-play-circle"></i> Iniciar
                                                    </button>
                                                }
                                                
                                                <button @onclick="() => CheckHealth(api.Id)" class="btn btn-info btn-sm">
                                                    <i class="bi bi-heart"></i> Verificar
                                                </button>
                                                
                                                <button @onclick="() => DeleteApi(api.Id)" class="btn btn-outline-danger btn-sm">
                                                    <i class="bi bi-trash"></i> Deletar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    @for (int i = notifications.Count - 1; i >= Math.Max(0, notifications.Count - 5); i--)
    {
        var notification = notifications[i];
        var index = i;
        <div class="toast show mb-2 @GetNotificationClass(notification.Type)" role="alert">
            <div class="toast-header">
                <i class="bi @GetNotificationIcon(notification.Type) me-2"></i>
                <strong class="me-auto">@notification.Title</strong>
                <small>@notification.Timestamp.ToString("HH:mm:ss")</small>
                <button type="button" class="btn-close" @onclick="() => RemoveNotification(index)"></button>
            </div>
            <div class="toast-body">
                @notification.Message
            </div>
        </div>
    }
</div>

@code {
    private ApiDeploymentRequest newApiRequest = new();
    private List<ApiDefinition>? apis;
    private bool isUploading;
    private bool loadingApis = true;
    private string? errorMessage;
    private string selectedFileName = string.Empty;
    private HubConnection? hubConnection;
    private List<NotificationItem> notifications = new();

    public class ApiDefinition
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string SwaggerJson { get; set; } = string.Empty;
        public string BaseUrl { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public DateTime? LastHealthCheck { get; set; }
        public string? ErrorMessage { get; set; }
        public Dictionary<string, object> Metadata { get; set; } = new();
    }

    public class ApiDeploymentRequest
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string SwaggerJson { get; set; } = string.Empty;
        public Dictionary<string, object> Configuration { get; set; } = new();
    }

    public class NotificationItem
    {
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadApis();
        await ConnectToNotificationHub();
    }

    private async Task LoadApis()
    {
        try
        {
            loadingApis = true;
            StateHasChanged();
            
            var response = await Http.GetAsync("http://localhost:8080/api/apis");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                apis = JsonSerializer.Deserialize<List<ApiDefinition>>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar APIs: {ex.Message}";
            AddNotification("Erro", errorMessage, "error");
        }
        finally
        {
            loadingApis = false;
            StateHasChanged();
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                if (file.Size > 10 * 1024 * 1024) // 10MB max
                {
                    errorMessage = "Arquivo muito grande. Máximo permitido: 10MB";
                    return;
                }

                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                using var reader = new StreamReader(stream);
                newApiRequest.SwaggerJson = await reader.ReadToEndAsync();
                
                // Validar JSON
                JsonDocument.Parse(newApiRequest.SwaggerJson);
                
                selectedFileName = file.Name;
                errorMessage = null;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = $"Erro ao ler arquivo: {ex.Message}";
                selectedFileName = string.Empty;
                newApiRequest.SwaggerJson = string.Empty;
            }
        }
    }

    private async Task CreateApi()
    {
        if (string.IsNullOrWhiteSpace(newApiRequest.Name) || string.IsNullOrWhiteSpace(newApiRequest.SwaggerJson))
        {
            errorMessage = "Nome e arquivo Swagger são obrigatórios";
            return;
        }

        isUploading = true;
        errorMessage = null;

        try
        {
            var json = JsonSerializer.Serialize(newApiRequest);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            
            var response = await Http.PostAsync("http://localhost:8080/api/apis", content);
            
            if (response.IsSuccessStatusCode)
            {
                newApiRequest = new ApiDeploymentRequest();
                selectedFileName = string.Empty;
                await LoadApis();
                AddNotification("Sucesso", "API criada com sucesso!", "success");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Erro ao criar API: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task StartApi(Guid id)
    {
        try
        {
            await Http.PostAsync($"http://localhost:8080/api/apis/{id}/start", null);
            await LoadApis();
        }
        catch (Exception ex)
        {
            AddNotification("Erro", $"Erro ao iniciar API: {ex.Message}", "error");
        }
    }

    private async Task StopApi(Guid id)
    {
        try
        {
            await Http.PostAsync($"http://localhost:8080/api/apis/{id}/stop", null);
            await LoadApis();
        }
        catch (Exception ex)
        {
            AddNotification("Erro", $"Erro ao parar API: {ex.Message}", "error");
        }
    }

    private async Task CheckHealth(Guid id)
    {
        try
        {
            await Http.GetAsync($"http://localhost:8080/api/apis/{id}/health");
            AddNotification("Info", "Verificação de saúde iniciada", "info");
        }
        catch (Exception ex)
        {
            AddNotification("Erro", $"Erro ao verificar saúde: {ex.Message}", "error");
        }
    }

    private async Task DeleteApi(Guid id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Tem certeza que deseja deletar esta API?");
        if (confirmed)
        {
            try
            {
                await Http.DeleteAsync($"http://localhost:8080/api/apis/{id}");
                await LoadApis();
                AddNotification("Sucesso", "API deletada com sucesso", "success");
            }
            catch (Exception ex)
            {
                AddNotification("Erro", $"Erro ao deletar API: {ex.Message}", "error");
            }
        }
    }

    private async Task ConnectToNotificationHub()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl("http://localhost:8080/notifications")
                .Build();

            hubConnection.On<object>("ApiStatusChanged", async (data) =>
            {
                var json = JsonSerializer.Serialize(data);
                var notification = JsonSerializer.Deserialize<Dictionary<string, object>>(json);
                
                AddNotification("Status da API", 
                    $"Status atualizado para {notification?["Status"]}", 
                    "info");
                
                await LoadApis();
                await InvokeAsync(StateHasChanged);
            });

            hubConnection.On<object>("ApiHealthCheck", (data) =>
            {
                var json = JsonSerializer.Serialize(data);
                var notification = JsonSerializer.Deserialize<Dictionary<string, object>>(json);
                
                var isHealthy = notification?["IsHealthy"]?.ToString() == "True";
                AddNotification("Verificação de Saúde", 
                    $"API {(isHealthy ? "saudável" : "com problemas")}", 
                    isHealthy ? "success" : "warning");
                
                InvokeAsync(StateHasChanged);
            });

            hubConnection.On<object>("Error", (data) =>
            {
                var json = JsonSerializer.Serialize(data);
                var notification = JsonSerializer.Deserialize<Dictionary<string, object>>(json);
                
                AddNotification("Erro", 
                    notification?["Message"]?.ToString() ?? "Erro desconhecido", 
                    "error");
                
                InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            AddNotification("Aviso", $"Conexão com notificações falhou: {ex.Message}", "warning");
        }
    }

    private void AddNotification(string title, string message, string type)
    {
        notifications.Add(new NotificationItem
        {
            Title = title,
            Message = message,
            Type = type,
            Timestamp = DateTime.Now
        });

        // Manter apenas as 10 últimas notificações
        if (notifications.Count > 10)
        {
            notifications.RemoveAt(0);
        }

        StateHasChanged();
    }

    private void RemoveNotification(int index)
    {
        if (index >= 0 && index < notifications.Count)
        {
            notifications.RemoveAt(index);
            StateHasChanged();
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Running" => "bg-success",
        "Deploying" => "bg-warning",
        "Failed" => "bg-danger",
        "Stopped" => "bg-secondary",
        _ => "bg-info"
    };

    private string GetApiCardBorderClass(string status) => status switch
    {
        "Running" => "border-success",
        "Deploying" => "border-warning",
        "Failed" => "border-danger",
        "Stopped" => "border-secondary",
        _ => "border-info"
    };

    private string GetStatusIcon(string status) => status switch
    {
        "Running" => "??",
        "Deploying" => "?",
        "Failed" => "?",
        "Stopped" => "??",
        _ => "??"
    };

    private string GetNotificationClass(string type) => type switch
    {
        "success" => "border-success",
        "warning" => "border-warning",
        "error" => "border-danger",
        _ => "border-info"
    };

    private string GetNotificationIcon(string type) => type switch
    {
        "success" => "bi-check-circle-fill text-success",
        "warning" => "bi-exclamation-triangle-fill text-warning",
        "error" => "bi-x-circle-fill text-danger",
        _ => "bi-info-circle-fill text-info"
    };

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}